daemon off;
#Heroku dynos have at least 4 cores.
worker_processes <%= ENV['NGINX_WORKERS'] || 4 %>;

events {
	use epoll;
	accept_mutex on;
	worker_connections 1024;
}

http {
	server {
		listen <%= ENV["PORT"] %>;
		sub_filter_once off;
		location ~ ^/blog(/?)(.*) {
			add_header 'Cache-Control' 'no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0';
			expires off;

			rewrite /blog/(.*) /$1  break;
			proxy_pass https://hicommon.wpengine.com;
			
		 	sub_filter         'hicommon.wpengine.com' 'ops-blog-proxy.herokuapp.com/blog';

		   	add_header    X-Original-Host                 ops-blog-proxy.herokuapp.com;
		   	proxy_set_header    Host                 hicommon.wpengine.com;
		   	proxy_set_header  X-Real-IP $remote_addr;
		    #proxy_set_header  X-Forwarded-Proto https;
		    #proxy_set_header  X-Scheme https;
		    proxy_set_header  X-Forwarded-For $remote_addr;
		    proxy_set_header  X-Forwarded-Host $remote_addr;
		}
	}
}